# Copyright 2014-2016 Spotify AB
# Copyright 2016-2018 The Last Pickle Ltd
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
sudo: required
dist: xenial
language: java
addons:
  postgresql: '9.4'
jdk:
- openjdk8
branches:
  only:
  - /^strapdata.*$/
  - /^\d+\.\d+\.\d+\.\d+$/
env:
  global:
  - CLOUDSDK_CORE_DISABLE_PROMPTS: 1
  - GCLOUD_PROJECT: strapdata-gcp-partnership
  - GCLOUD_ZONE: europe-west1-b
  - LOCAL_JMX=no
  - TEST=""
cache:
  directories:
    - $HOME/google-cloud-sdk/

stages:
- Integration Tests
- Distributed Reaper Integration Tests
- Flapping Distributed Reaper Integration Tests
- name: Upgrade Integration Tests
- Docker
- name: Deploy
  if: branch = strapdata-1.4.7 OR tag IS present
jobs:
  fast_finish: true
  allow_failures:
  - env: TEST_TYPE=docker
  - env: TEST_TYPE=ccm CASSANDRA_VERSION=git:trunk GRIM_MIN=1 GRIM_MAX=1
  - env: TEST_TYPE=ccm CASSANDRA_VERSION=git:trunk GRIM_MIN=2 GRIM_MAX=2
  - env: TEST_TYPE=ccm CASSANDRA_VERSION=git:trunk GRIM_MIN=2 GRIM_MAX=4
  - env: TEST_TYPE=upgrade CASSANDRA_VERSION=git:trunk CO="-t @all_nodes_reachable"
  - env: TEST_TYPE=upgrade CASSANDRA_VERSION=git:trunk CO="-t ~@all_nodes_reachable"
  include:
  - stage: Integration Tests
    name: Memory, H2 and Postgresql
    env: TEST_TYPE=ccm CASSANDRA_VERSION=2.1.20
  - stage: Integration Tests
    name: Cassandra 3.11.3
    env: TEST_TYPE=ccm CASSANDRA_VERSION=3.11.3 GRIM_MIN=1 GRIM_MAX=1
  - stage: Integration Tests
    name: Cassandra 4.0
    env: TEST_TYPE=ccm CASSANDRA_VERSION=git:trunk GRIM_MIN=1 GRIM_MAX=1
  - stage: Distributed Reaper Integration Tests
    name: Two Reapers on Cassandra 3.11.3
    env: TEST_TYPE=ccm CASSANDRA_VERSION=3.11.3 GRIM_MIN=2 GRIM_MAX=2
  - stage: Distributed Reaper Integration Tests
    name: Two Reapers on Cassandra 4.0
    env: TEST_TYPE=ccm CASSANDRA_VERSION=git:trunk GRIM_MIN=2 GRIM_MAX=2
  - stage: Flapping Distributed Reaper Integration Tests
    name: Four Flapping Reaper on Cassandra 3.11.3
    env: TEST_TYPE=ccm CASSANDRA_VERSION=3.11.3 GRIM_MIN=2 GRIM_MAX=4
  - stage: Flapping Distributed Reaper Integration Tests
    name: Four Flapping Reaper on Cassandra 4.0
    env: TEST_TYPE=ccm CASSANDRA_VERSION=git:trunk GRIM_MIN=2 GRIM_MAX=4
  - stage: Upgrade Integration Tests
    name: Upgrading Reaper on Cassandra 3.11.3 (all_nodes_reachable)
    env: TEST_TYPE=upgrade CASSANDRA_VERSION=3.11.3 CO="-t @all_nodes_reachable"
  - stage: Upgrade Integration Tests
    name: Upgrading Reaper on Cassandra 3.11.3
    env: TEST_TYPE=upgrade CASSANDRA_VERSION=3.11.3 CO="-t ~@all_nodes_reachable"
  - stage: Upgrade Integration Tests
    name: Upgrading Reaper on Cassandra 4.0 (all_nodes_reachable)
    env: TEST_TYPE=upgrade CASSANDRA_VERSION=git:trunk CO="-t @all_nodes_reachable"
  - stage: Upgrade Integration Tests
    name: Upgrading Reaper on Cassandra 4.0
    env: TEST_TYPE=upgrade CASSANDRA_VERSION=git:trunk CO="-t ~@all_nodes_reachable"
  - stage: Deploy
    name: Deploy
    env: TEST_TYPE=deploy
    before_deploy: "./src/ci/before_deploy.sh"
    deploy:
#    - provider: releases
      #      api_key:
      #  secure: PisRj7LQme5jq52aceJjlycU8MdMxoSVtWu+QjcYqiIaNCHUhPeIR6TNyCopGhUtcN+9gaTrIxwBHn/98k5y5CUt5QZ2NgxBrfhZdeLKj01mL3V63/40lL89T+udoIwxaVEmtKFvbVpL4xoAEonkrtqKu1cmfKbc7oGLOJu6C6sbEWuNcLrEQnRlbSm8BShDPCY9AyQ/EIuSgrRrBQX0aWucbvLdCEIYO2h1aDYGulRYWT0IRIDuflo/sEMxyhexPva9qwAghyZVNoPl9TUGoXiz1BueAQfKTZiuwSDLZuupB5dS9EVarN/bBDpjA5su0/0M5lBGcjBDontFXK7y6Wfo2WGAp7q4WrX08wFTp8iSh92GdFL7ipdvM+uQJNuhFGQJNtgQBroAhpriBYmXDXcJDIeVj56LNKSJOIDJxu5g8AS8J2W5r8P8FBiuudPjmilPFRhS5Qh0vmzYbL4KCJvaIVkLzTJfbyzDhmXsCLLoAubnQGw8X/fvK/GRu1iHndgr+3NwJ3KvPJwPcdppKhI+PzHZyTVADX89tYvrY+5B3iV4yUOc8DGAQysHKbv0E67dqGburHNuszzncIHJJAC88W7vmKdrU8pniW4L2ZXMIQPnYDZkWckT3Hx+gRlRUzLbjQn89QZ4eDZEHVIRwsp61KDuaE5FCfQmnOxGGg0=
      #file_glob: true
      #file:
      #- src/packages/cassandra-reaper-${TRAVIS_TAG}-release.tar.gz
      #- src/packages/reaper-*-1.x86_64.rpm
      #- src/packages/reaper_*_amd64.deb
      #skip_cleanup: true
      #on:
      #  tags: true
    - provider: script
      script: "./src/ci/publishImages.sh"
      skip_cleanup: true
      on:
        tags: true
        branch: strapdata-1.4.7
services:
- postgresql
- docker
before_install:
- if [ ! -d "$HOME/google-cloud-sdk/bin" ]; then rm -rf $HOME/google-cloud-sdk; curl
  https://sdk.cloud.google.com | bash; fi
- source /home/travis/google-cloud-sdk/path.bash.inc
- gcloud -v
- echo "$GCLOUD_SECRET_KEY" | base64 -d > gcloud-secret.json
- gcloud auth activate-service-account --key-file gcloud-secret.json
- cat gcloud-secret.json | docker login -u _json_key --password-stdin https://gcr.io
- echo "$NEXUS_PASSWORD" | docker login --username "$NEXUS_USERNAME" docker.repo.strapdata.com --password-stdin
- "./src/ci/before_install.sh"
install: "./src/ci/install.sh"
before_script: "./src/ci/before_script.sh"
script: "./src/ci/script.sh"
after_failure: "./src/ci/after_failure.sh"
